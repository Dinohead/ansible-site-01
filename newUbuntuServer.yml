---
#========================
# File newUbuntuServer.yml
#
# Description: Creates a VM on a Hyper-V host
#
# Author: dRock Halsey

- name: PLAYBOOK | newUbuntuServer - create a new Ubuntu Server on the Hyper-V host
  hosts: hyper-v[0]
  tasks:

  - name: WIN_FILE | Ensure Directories are present for new VM
    win_file:
      path: "{{ item }}"
      state: directory
    with_items:
      - C:\ClusterStorage\cluster-storage-01\vm\testVM
      - C:\ClusterStorage\cluster-storage-01\vm\testVM\Virtual Hard Disks

  # This check will be used to determine if the VM already exists. If the hard drive
  # for the VM is found in the expected location, it will be assumed that the VM
  # already exists. This is to prevent copying the template hard drive over an
  # existing hard drive (the script should not be destructive to existing VMs).
  - name: WIN_STAT | Check if the vhdx is present
    win_stat:
      path: C:\ClusterStorage\cluster-storage-01\vm\testVM\Virtual Hard Disks\disk-0.vhdx
      get_md5: false
      get_checksum: false
    register: newUbuntuServer_vmVhdx

  - name: WIN_COPY | Copy the VM template vhdx to the new directory
    win_copy:
      src: C:\ClusterStorage\cluster-storage-01\vhdx-templates\ubuntu-server-1604.vhdx
      dest: C:\ClusterStorage\cluster-storage-01\vm\testVM\Virtual Hard Disks\disk-0.vhdx
      remote_src: true
    when: not newUbuntuServer_vmVhdx.stat.exists

  - name: WIN_SHELL | Create VM in Hyper-V
    win_shell: |-
      if (!(Get-VM -name testVM -erroraction 'ignore')) {
        New-VM -Name "testVM" -ComputerName data -VHDPath "C:\ClusterStorage\cluster-storage-01\vm\testVM\Virtual Hard Disks\disk-0.vhdx" -Path "C:\ClusterStorage\cluster-storage-01\vm" }

  - name: WIN_SHELL | Set Number of Proccessors
    win_shell: Set-VMProcessor testVM -Count 2

  - name: WIN_SHELL | Set VM Memory
    win_shell: Set-VM -Name testVM -DynamicMemory -MemoryMaximumBytes 4GB -MemoryStartupBytes 1GB

  - name: WIN_SHELL | Disconnect NIC
    win_shell: Disconnect-VMNetworkAdapter -VMName testVM

  - name: WIN_SHELL | Start VM
    win_shell: start-vm testVM

  - name: SCRIPT | Run networking script to configure networking
    script: scripts/setHypervVmNetworking.ps1

  - name: WIN_SHELL | Restart VM
    win_shell: restart-vm testVM -force

  - name: WIN_SHELL | Connect NIC
    win_shell: Connect-VMNetworkAdapter -VMName testVM -SwitchName SW-1G

- hosts: testVM.DINOHEAD.NINJA
  connection: local
  gather_facts: false

  tasks:
  - wait_for:
      host: 10.0.1.29
      port: 22
      state: present

- hosts: dc[0]
  tasks:

  - name: WIN_SHELL | Register DNS entry with Domain Controller
    win_shell: |-
      if (!(Get-DnsServerResourceRecord -Name "testVM" -ZoneName "dinohead.ninja" -erroraction 'ignore')) {
        Add-DnsServerResourceRecordA -Name "testVM" -ZoneName "dinohead.ninja" -AllowUpdateAny -IPv4Address "10.0.1.29" }
      else {
        Remove-DnsServerResourceRecord -ZoneName "dinohead.ninja" -RRType "A" -Name "testVM" -Force;
        Add-DnsServerResourceRecordA -Name "testVM" -ZoneName "dinohead.ninja" -AllowUpdateAny -IPv4Address "10.0.1.29" }

- hosts: hyper-v-cluster[0]
  tasks:

  - name: WIN_SHELL | Add VM to Cluster
    win_shell: |-
      if (!(Get-ClusterResource -Cluster kirk -Name "Virtual Machine testVM" -erroraction 'ignore')) {
        Add-ClusterVirtualMachineRole -VMName testVM -Cluster kirk }

